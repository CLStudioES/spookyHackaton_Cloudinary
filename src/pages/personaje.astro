---
import Layout from "../layouts/Layout.astro";
import { CldUploadWidget } from "astro-cloudinary";
---

<Layout title="Spooky Hackaton - Crea tu personaje">
    <main
        class="hidden lg:flex items-center justify-center h-screen w-screen overflow-hidden"
    >
        <div class="relative h-screen w-screen">
            <!-- Bottom layer -->
            <div class="absolute inset-0 z-0">
                <div class="moon"></div>
            </div>
            <!-- Second layer -->
            <div
                class="absolute inset-0 z-20 bg-[url('/img/ui/backgrounds/composition_character/3.png')] bg-cover lg:bg-center bg-no-repeat"
            >
            </div>
            <div
                class="absolute inset-0 z-20 bg-[url('/img/ui/backgrounds/composition_character/3.png')] bg-cover lg:bg-center bg-no-repeat"
            >
            </div>
            <!-- Third layer -->
            <div class="absolute inset-0 z-10">
                <div id="foglayer_01" class="fog hidden lg:flex">
                    <div class="image01"></div>
                    <div class="image02"></div>
                </div>
                <div id="foglayer_02" class="fog hidden lg:flex">
                    <div class="image01"></div>
                    <div class="image02"></div>
                </div>
                <div id="foglayer_03" class="fog hidden lg:flex">
                    <div class="image01"></div>
                    <div class="image02"></div>
                </div>
            </div>
            <!--Fourth layer -->
            <div
                id="grave"
                transition:name="grave"
                class="absolute inset-0 z-30 bg-[url('/img/ui/backgrounds/composition_character/2.png')] bg-cover lg:bg-center bg-no-repeat"
            >
            </div>
            <!--Fifth layer -->
            <div
                class="absolute inset-0 z-40 bg-[url('/img/ui/backgrounds/composition_character/1.png')] bg-cover lg:bg-center bg-no-repeat"
            >
            </div>
            <!--Front layer -->
            <div class="absolute inset-0 z-50 flex items-center justify-center">
                <div
                    class="w-[15%] h-[50%] flex items-center justify-center mt-44"
                >
                    <div
                        class="w-full h-full overflow-clip flex flex-col items-center"
                    >
                        <span
                            class="h-24 w-24 lg:h-60 lg:w-60 rounded-full block border border-white mb-8 cursor-pointer overflow-hidden"
                        >
                            <two-up>
                                <img
                                    id="graveImageOriginal"
                                    src=""
                                    class="w-full h-full object-cover"
                                />
                                <img
                                    id="graveImageDead"
                                    src=""
                                    class="w-full h-full object-cover"
                                />
                            </two-up>
                        </span>
                        <CldUploadWidget
                            id="uploadWidget"
                            uploadPreset="upload-unisgned-images"
                            options={{
                                sources: ["local", "camera"],
                                multiple: false,
                                maxFiles: 1,
                                language: "es",
                                text: {
                                    en: {
                                        or: "O",
                                    },
                                    es: {
                                        menu: {
                                            files: "Mis archivos",
                                            camera: "Cámara",
                                        },
                                        local: {
                                            dd_title_single:
                                                "Arrastra tu imagen aquí",
                                            browse: "Seleccionar",
                                        },
                                        camera: {
                                            capture: "Capturar",
                                            cancel: "Cancelar",
                                            take_pic: "Saca una foto y súbela",
                                            explanation:
                                                "Make sure that your camera is connected and that your browser allows camera capture. When ready, click Capture.",
                                            camera_error:
                                                "Error al acceder a la cámara",
                                            retry: "Volver a intentar",
                                            file_name: "Camera_{{time}}",
                                        },
                                    },
                                },
                                styles: {
                                    palette: {
                                        window: "#8E8E8E",
                                        windowBorder: "#9356A3",
                                        tabIcon: "#3D224B",
                                        menuIcons: "#5A616A",
                                        textDark: "#000000",
                                        textLight: "#FFFFFF",
                                        link: "#3D224B",
                                        action: "#ADEF13",
                                        inactiveTabIcon: "#3D224B",
                                        error: "#F44235",
                                        inProgress: "#0078FF",
                                        complete: "#20B832",
                                        sourceBg: "#E4EBF1",
                                    },
                                    frame: {
                                        background: "#0E2F5B99",
                                    },
                                },
                            }}
                            ><button class="graven-text mb-4 group relative"
                                ><img
                                    class="h-8 opacity-50 hover:opacity-100 transition-all duration-200"
                                    src="/img/icons/imageUp.svg"
                                />
                                <span
                                    class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white px-2 py-1 rounded text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap"
                                >
                                    Subir imagen</span
                                ></button
                            ></CldUploadWidget
                        >
                        <h2
                            id="labelNombre"
                            contenteditable="true"
                            class="cursor-pointer text-sm lg:text-3xl graven-text uppercase truncate overflow-hidden max-w-96 text-center focus:outline-none focus:border-b-2 focus:border-trickle-green"
                        >
                            Tu nombre
                        </h2>
                        <span
                            class="graven-text uppercase truncate pt-1 lg:pt-3 text-xs lg:text-2xl flex flex-row"
                        >
                            <input
                                id="inputFnacimiento"
                                type="date"
                                placeholder=""
                                class="focus:outline-none focus:border-b-2 focus:border-trickle-green graven-text cursor-pointer"
                            /><span class="pt-[2px]"> 22/10/2024</span>
                        </span>
                        <p
                            id="labelPalabras"
                            class="graven-text uppercase text-xs lg:text-2xl text-center px-4 my-auto bottom-0 cursor-pointer max-h-16 overflow-clip"
                        >
                            <span>"</span><span
                                class="focus:outline-none focus:border-b-2 focus:border-trickle-green"
                                contenteditable="true"
                            >
                                FINIS OMNIS VITA MORS EST
                            </span><span>"</span>
                        </p>
                        <button
                            id="saveButton"
                            class="graven-text mb-12 group relative"
                            ><img
                                class="h-8 opacity-50 hover:opacity-100 transition-all duration-200"
                                src="/img/icons/save.svg"
                            />
                            <span
                                class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white px-2 py-1 rounded text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap"
                            >
                                Guardar</span
                            ></button
                        >
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>
<script>
    import { getCldImageUrl } from "astro-cloudinary/helpers";
    import "two-up-element";

    const widget = document.getElementById("uploadWidget");
    let secure_url = "";
    let normal_url = "";
    let hell_url = "";
    let heaven_url = "";
    let dead_url = "";
    let aspect_url = "";

    if (widget) {
        widget.addEventListener("clduploadwidget:success", ((
            e: CustomEvent<{ info: { public_id: string; secure_url: string } }>,
        ) => {
            const publicId = e.detail.info.public_id;
            secure_url = e.detail.info.secure_url;

            normal_url = getCldImageUrl({
                src: secure_url,
                width: 300,
                height: 300,
                crop: "fill",
                gravity: "center",
            });
            dead_url = getCldImageUrl({
                src: secure_url,
                replaceBackground: "graveyard background with zombies",
                width: 300,
                height: 300,
                crop: "fill",
                gravity: "center",
                grayscale: true,
            });

            heaven_url = getCldImageUrl({
                src: secure_url,
                replaceBackground: "heaven with angels",
                width: 300,
                height: 300,
                crop: "fill",
                gravity: "center",
                grayscale: true,
            });
            hell_url = getCldImageUrl({
                src: secure_url,
                replaceBackground: "hell with dead people",
                width: 300,
                height: 300,
                crop: "fill",
                gravity: "center",
                grayscale: true,
            });
            aspect_url = getCldImageUrl({
                src: secure_url,
                replaceBackground: "graveyard background with zombies",
                aspectRatio: "16:9",
                crop: "fill",
                gravity: "center",
                grayscale: true,
            });

            console.log(dead_url);
            console.log(heaven_url);
            console.log(hell_url);
            // Get the image element
            const graveImageOriginal = document.getElementById(
                "graveImageOriginal",
            ) as HTMLImageElement;
            const graveImageDead = document.getElementById(
                "graveImageDead",
            ) as HTMLImageElement;

            // Update the src attribute with the new secure_url
            if (graveImageOriginal && graveImageDead) {
                graveImageOriginal.src = normal_url;
                graveImageDead.src = dead_url;
            }
        }) as EventListener);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const saveButton = document.getElementById("saveButton");
        const labelNombre = document.getElementById("labelNombre");
        const inputFnacimiento = document.getElementById(
            "inputFnacimiento",
        ) as HTMLInputElement;
        const labelPalabras = document.getElementById("labelPalabras");

        if (saveButton && labelNombre && inputFnacimiento && labelPalabras) {
            saveButton.addEventListener("click", () => {
                // Get the values you want to send
                const nombre = labelNombre.textContent?.trim() || "";
                const fechaNacimiento = inputFnacimiento.value;
                const palabras = labelPalabras.textContent?.trim() || "";

                // Encode the values to be URL-safe
                const params = new URLSearchParams({
                    nombre: nombre,
                    fechaNacimiento: fechaNacimiento,
                    palabras: palabras,
                    aspectUrl: aspect_url,
                });

                // Navigate to the new page with the parameters
                window.location.href = `/historia?${params.toString()}`;
            });
        }
    });
</script>

<style>
    input[type="date"]::-webkit-calendar-picker-indicator {
        display: none;
        -webkit-appearance: none;
        padding: 0;
    }
    input[type="date"] {
        padding: 0;
        margin: 0;
        border: none;
        background: transparent;
    }

    input[type="date"]::-webkit-datetime-edit,
    input[type="date"]::-webkit-datetime-edit-fields-wrapper,
    input[type="date"]::-webkit-datetime-edit-text,
    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field {
        padding: 0;
        margin: 0;
    }

    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-calendar-picker-indicator {
        display: none;
        -webkit-appearance: none;
    }
</style>
