---
import storyData from "../data/story.json";
import CinemaLayout from "../layouts/cinemaLayout.astro";
import StoryContainer from "../components/storyContainer.astro";
import OptionButton from "../components/optionButton.astro";
import ImageContainer from "../components/imageContainer.astro";
import VozContainer from "../components/vozContainer.astro";

const params = Astro.url.searchParams;

const storyList = storyData.stories;
const initialStoryId = storyList[0].id;

const nombre = params.get("nombre") || "";
const fechaNacimiento = params.get("fechaNacimiento") || "";
const palabras = params.get("palabras") || "";
const aspectUrl = params.get("aspectUrl") || "";
const normalUrl = params.get("normalUrl") || "";
---

<CinemaLayout title="Spooky Hackaton-Tu historia">
    <div class="relative min-h-screen">
        <img
            src="/img/ui/backgrounds/composition_historia/room_1.png"
            alt="Room background"
            class="absolute bg-cover bg-center bg-no-repeat w-full h-screen"
        />
        <main
            class="relative z-10 flex flex-col items-center justify-center min-h-screen p-4"
        >
            <div class="max-w-7xl w-full text-center">
                {
                    storyList.map((story) => (
                        <div id={`story-${story.id}`} class="mb-6 hidden">
                            <div class="bg-white rounded-2xl py-10 bg-opacity-75 sm:bg-opacity-20 sm:backdrop-filter sm:backdrop-blur-lg 
           border border-black border-opacity-20 shadow-lg">
                            <ImageContainer
                                prompt={story.imagePrompt}
                                Url={normalUrl}
                            />
                            <StoryContainer
                                titulo={story.titulo}
                                texto={story.texto}
                            />
                            </div>
                            {story.comentario && story.personaje && (
                                <VozContainer
                                    comentario={story.comentario}
                                    personaje={story.personaje}
                                />
                            )}
                        </div>
                    ))
                }
                <div
                    id="button-container"
                    class="flex flex-wrap justify-center gap-4"
                >
                    {
                        [1, 2, 3, 4].map((i) => (
                            <OptionButton
                                id={`button-${i}`}
                                label=""
                                onClick=""
                                class="hidden"
                            />
                        ))
                    }
                </div>
            </div>
        </main>
    </div>
</CinemaLayout>

<script define:vars={{ storyList, initialStoryId, normalUrl }}>
    function displayStory(id) {
        const story = storyList.find((s) => s.id === id);
        if (story) {
            // Hide all story containers
            storyList.forEach((s) => {
                const container = document.getElementById(`story-${s.id}`);
                if (container) container.style.display = "none";
            });

            // Show the selected story container
            const selectedContainer = document.getElementById(`story-${id}`);
            if (selectedContainer) selectedContainer.style.display = "block";

            // Update buttons
            for (let i = 1; i <= 4; i++) {
                const button = document.getElementById(`button-${i}`);
                const labelKey = `label_button${i}`;
                const gotoKey = `goto_button${i}`;

                if (
                    story[labelKey] &&
                    story[gotoKey] &&
                    story[gotoKey] !== "none"
                ) {
                    button.textContent = story[labelKey];
                    button.onclick = () => {
                        const createUrl = (path) =>
                            `${path}?normalUrl=${encodeURIComponent(normalUrl)}`;

                        // Check for special endings
                        if (id === "15c") {
                            window.location.href = createUrl("/malo");
                        } else if (id === "15a") {
                            window.location.href = createUrl("/bueno");
                        } else if (id === "15b") {
                            window.location.href = createUrl("/medio");
                        } else if (story[gotoKey] === "gracias") {
                            // Keep the existing "gracias" redirect
                            window.location.href = createUrl("/gracias");
                        } else {
                            // Otherwise, continue with normal story navigation
                            displayStory(story[gotoKey]);
                        }
                    };
                    button.style.display = "block";
                } else {
                    button.style.display = "none";
                }
            }
        } else {
            console.error("Story not found");
        }
    }

    // Display the initial story on page load
    displayStory(initialStoryId);
</script>

<style>
    #button-container {
        display: flex;
        margin-top: 20px;
    }
</style>
